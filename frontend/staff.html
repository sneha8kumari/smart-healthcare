<!DOCTYPE html>
<html>
<head>
    <title>Staff Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">   
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
     <link rel="stylesheet" href="style.css">

    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body class="container mt-4">
<button class="btn btn-danger float-end" onclick="logout()">Logout</button>
<br><br>
<h1>Staff Dashboard</h1>

<h2>Current Token Being Served</h2>
<p id="currentToken">Loading...</p>

<h2>Walk-in Queue</h2>
<button class="btn btn-primary" onclick="loadQueue()">Refresh Queue</button>
<ul id="queueList"></ul>

<h2>Call Next Patient</h2>
<button class="btn btn-success" onclick="callNext()">Call Next</button>

<p id="callResult" class="mt-3"></p>

<h2>Queue Statistics</h2>
<canvas id="queueGraph" width="300" height="200"></canvas>

<script>

// ---------------------- LOAD CURRENT TOKEN ------------------
async function loadCurrentToken() {
    const res = await fetch("http://localhost:5000/api/current-token");
    const data = await res.json();
    document.getElementById("currentToken").innerText =
        data.token_no ? data.token_no : "None";
}


// ---------------------- LOAD QUEUE LIST ------------------
async function loadQueue() {
    const res = await fetch("http://localhost:5000/api/queue");
    const data = await res.json();

    let ul = document.getElementById("queueList");
    ul.innerHTML = "";

    data.forEach(item => {
        let li = document.createElement("li");
        li.innerText = `Token ${item.token_no} - ${item.status}`;
        ul.appendChild(li);
    });
}


// ---------------------- CALL NEXT PATIENT ------------------
async function callNext() {
    const res = await fetch("http://localhost:5000/api/call-next", {
        method: "POST"
    });
    const data = await res.json();

    document.getElementById("callResult").innerText =
        data.message + (data.token_no ? (" Token: " + data.token_no) : "");

    loadQueue();
    loadCurrentToken();
    loadGraph();
}


// ---------------------- LOAD CHART ------------------
async function loadGraph() {
    const res = await fetch("http://localhost:5000/api/queue");
    const data = await res.json();

    let waiting = data.filter(x => x.status === "waiting").length;
    let called = data.filter(x => x.status === "called").length;

    const ctx = document.getElementById('queueGraph');

    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Waiting', 'Called'],
            datasets: [{
                data: [waiting, called],
                backgroundColor: ['blue', 'green']
            }]
        }
    });
}


// ---------------------- SOCKET.IO (REAL-TIME) ------------------
const socket = io("http://localhost:5000");

socket.on("queue-update", () => {
    loadQueue();
    loadCurrentToken();
    loadGraph();
});

socket.on("call-update", token => {
    let msg = new SpeechSynthesisUtterance(
        "Token number " + token + " please proceed to the counter."
    );
    window.speechSynthesis.speak(msg);
});


// ---------------------- INITIAL LOAD ------------------
loadQueue();
loadCurrentToken();
loadGraph();

// Auto refresh every 5 seconds
setInterval(() => {
    loadQueue();
    loadCurrentToken();
    loadGraph();
}, 5000);
function logout() {
    localStorage.removeItem("staffToken");
    window.location.href = "staff-login.html";
}

</script>

</body>
</html>
